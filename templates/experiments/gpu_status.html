{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-microchip me-2"></i>{{ title }}</h1>
    <button class="btn btn-primary" onclick="location.reload()">
        <i class="fas fa-sync-alt me-1"></i>刷新
    </button>
</div>

{% if gpu_info %}
<div class="row">
    {% for gpu_index, gpu_data in gpu_info.items %}
    <div class="col-lg-6 col-xl-4 mb-4">
        <div class="card h-100 {% if gpu_data.memory_used_percent > 20 %}border-danger{% else %}border-success{% endif %}">
            <div class="card-header {% if gpu_data.memory_used_percent > 20 %}bg-danger text-white{% else %}bg-success text-white{% endif %}">
                <h5 class="mb-0">
                    <i class="fas fa-microchip me-2"></i>GPU {{ gpu_index }}
                    {% if gpu_data.memory_used_percent > 20 %}
                        <span class="badge bg-light text-dark ms-2">繁忙</span>
                    {% else %}
                        <span class="badge bg-light text-dark ms-2">空闲</span>
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <!-- 显存使用率 -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <small class="text-muted">显存使用率</small>
                        <small class="text-muted">{{ gpu_data.memory_used_percent }}%</small>
                    </div>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar {% if gpu_data.memory_used_percent > 20 %}bg-danger{% else %}bg-success{% endif %}" 
                             style="width: {{ gpu_data.memory_used_percent }}%">
                            {{ gpu_data.memory_used_percent }}%
                        </div>
                    </div>
                </div>

                <!-- 显存详情 -->
                <div class="row text-center">
                    <div class="col-6">
                        <div class="border-end">
                            <div class="h6 mb-0 text-primary">{{ gpu_data.memory_used }}</div>
                            <small class="text-muted">已使用 (MB)</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="h6 mb-0 text-info">{{ gpu_data.memory_total }}</div>
                        <small class="text-muted">总容量 (MB)</small>
                    </div>
                </div>

                <!-- 可用显存 -->
                <div class="mt-3 text-center">
                    <div class="h6 mb-0 text-success">{{ gpu_data.memory_total|add:0|add:gpu_data.memory_used|add:-gpu_data.memory_used|add:gpu_data.memory_total|add:-gpu_data.memory_used }}</div>
                    <small class="text-muted">可用显存 (MB)</small>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- 系统信息 -->
<div class="card mt-4">
    <div class="card-header">
        <h5><i class="fas fa-info-circle me-2"></i>检测信息</h5>
    </div>
    <div class="card-body">
        <div class="alert alert-info">
            <h6 class="alert-heading">说明</h6>
            <ul class="mb-0">
                <li>显存使用率超过 <strong>20%</strong> 的GPU被标记为繁忙状态</li>
                <li>启动实验时会自动检查所需GPU的使用情况</li>
                <li>如果GPU繁忙，系统会提示用户选择加入排队或强制启动</li>
                <li>数据来源：<code>nvidia-smi</code> 命令</li>
            </ul>
        </div>
    </div>
</div>

{% else %}
<div class="text-center py-5">
    <i class="fas fa-exclamation-triangle text-warning fa-3x mb-3"></i>
    <h4 class="text-muted">无法获取GPU信息</h4>
    <p class="text-muted">可能原因：</p>
    <ul class="list-unstyled text-muted">
        <li>• 系统中没有安装NVIDIA驱动</li>
        <li>• nvidia-smi命令不可用</li>
        <li>• 没有NVIDIA GPU设备</li>
        <li>• 权限不足</li>
    </ul>
</div>
{% endif %}

<div class="mt-4 text-center">
    <a href="{% url 'experiments:list' %}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-1"></i>返回实验列表
    </a>
</div>

<script>
// 自动刷新页面
setInterval(function() {
    location.reload();
}, 30000); // 每30秒刷新一次
</script>
{% endblock %}
