{% extends 'base.html' %}

{% block title %}编辑模块 - {{ file_name }}{% endblock %}

{% load static %}

{% block extra_css %}
<link href="{% static 'js/codemirror-5.65.0/lib/codemirror.css' %}" rel="stylesheet">
<link href="{% static 'js/codemirror-5.65.0/theme/monokai.css' %}" rel="stylesheet">
<link href="{% static 'js/codemirror-5.65.0/addon/hint/show-hint.css' %}" rel="stylesheet">
<!-- CodeMirror CSS -->
<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.0/lib/codemirror.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.0/theme/monokai.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.0/addon/hint/show-hint.min.css"> -->

<style>
.CodeMirror {
    height: 600px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-size: 14px;
}

.editor-toolbar {
    background: #f8f9fa;
    border: 1px solid #ddd;
    border-bottom: none;
    border-radius: 4px 4px 0 0;
    padding: 8px 12px;
}

.editor-container {
    position: relative;
}

/* 编辑器加载遮罩样式 */
.editor-loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    height: 600px; /* 与CodeMirror相同的高度 */
    background: linear-gradient(135deg, #272822 0%, #2f3129 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    transition: opacity 0.3s ease-out, visibility 0.3s ease-out;
    border-radius: 4px;
    border: 1px solid #ddd; /* 与CodeMirror相同的边框 */
}

.editor-loading-overlay.hidden {
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
}

/* 编辑器容器 */
#editorContainer {
    position: relative;
    min-height: 600px; /* 与CodeMirror相同的最小高度 */
}

.file-info-bar {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.save-status {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    padding: 10px 15px;
    border-radius: 20px;
    color: white;
    font-weight: bold;
    opacity: 0;
    transition: opacity 0.3s;
}

.save-status.show {
    opacity: 1;
}

.save-status.success {
    background: #4caf50;
}

.save-status.error {
    background: #f44336;
}

.editing-warning {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    color: #856404;
    padding: 12px;
    border-radius: 6px;
    margin-bottom: 15px;
}

.readonly-mode .CodeMirror {
    background-color: #2f3129 !important; /* 保持monokai主题的深色背景 */
    cursor: default;
    opacity: 1; /* 稍微透明一点表示只读 */
}

.edit-mode .CodeMirror {
    background-color: #272822 !important; /* monokai主题原始背景色 */
    border-color: #28a745 !important;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
    opacity: 1; /* 完全不透明表示可编辑 */
}

.mode-indicator {
    position: absolute;
    top: 10px;
    right: 10px;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
    z-index: 10;
}

.mode-indicator.readonly {
    background: rgba(108, 117, 125, 0.9);
    color: white;
    border: 1px solid #6c757d;
}

.mode-indicator.editing {
    background: rgba(40, 167, 69, 0.9);
    color: white;
    border: 1px solid #28a745;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}

.loading-content {
    text-align: center;
    color: white;
}

.loading-content .spinner-border {
    width: 3rem;
    height: 3rem;
    border-width: 0.3em;
    /* 加快旋转速度 */
    animation: spinner-border 0.2s linear infinite;
}

/* 自定义更快的旋转动画 */
@keyframes spinner-border {
    0% {
        transform: rotate(0deg);
    }
    100% {
        transform: rotate(360deg);
    }
}

/* 额外的加载动画效果 */
.loading-content::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 4rem;
    height: 4rem;
    margin: -2rem 0 0 -2rem;
    border: 2px solid transparent;
    border-top: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    animation: pulse-ring 1.5s ease-in-out infinite;
}

@keyframes pulse-ring {
    0% {
        transform: scale(0.8);
        opacity: 1;
    }
    100% {
        transform: scale(1.2);
        opacity: 0;
    }
}

.loading-text h5 {
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.loading-text p {
    font-size: 14px;
    margin-bottom: 0;
}

/* CodeMirror 平滑过渡 */
.CodeMirror {
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.1s ease-in-out, visibility 0.8s ease-in-out;
}

.CodeMirror.cm-ready {
    opacity: 1;
    visibility: visible;
}

/* 初始隐藏原始textarea */
#codeEditor {
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.1s ease-in-out, visibility 0.1s ease-in-out;
}

/* 编辑器容器 */
#editorContainer {
    position: relative;
    min-height: 400px;
}

/* 模块信息区域样式优化 */
.module-info-sidebar {
    max-height: 600px;
    overflow-y: auto;
}

.module-item-card {
    transition: all 0.2s ease;
    border: 1px solid #e9ecef !important;
}

.module-item-card:hover {
    background-color: #f8f9fa;
    border-color: #007bff !important;
}

.module-actions .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
}

.module-item-classified {
    border-radius: 0.25rem;
    background-color: #f8f9fa;
}

.category-section {
    border-radius: 0.5rem;
    border: 1px solid #e9ecef;
    padding: 0.5rem;
}

.category-header {
    border-radius: 0.25rem !important;
    margin-bottom: 0.5rem;
}

/* 响应式调整 */
@media (max-width: 768px) {
    .col-md-10 {
        margin-bottom: 1rem;
    }
    
    .module-info-sidebar {
        max-height: 300px;
        overflow-y: auto;
    }
}

/* 模块信息侧边栏在更窄空间下的样式优化 */
.module-info-sidebar {
    font-size: 0.85rem;
}

.module-info-sidebar .card-header h6 {
    font-size: 0.8rem;
}

.module-info-sidebar .module-name {
    font-size: 0.75rem;
    font-weight: 600;
}

.module-info-sidebar .btn-sm {
    padding: 0.2rem 0.4rem;
    font-size: 0.7rem;
}

/* 模块信息卡片文字大小调整 */
.module-info-sidebar .card-body {
    padding: 0.75rem;
}

.module-info-sidebar h6 {
    font-size: 0.9rem;
}

.module-info-sidebar small {
    font-size: 0.75rem;
}

.module-name {
    font-size: 0.85rem;
    line-height: 1.2;
}

/* 已分类模块显示样式 */
.classified-modules-list .category-group {
    border-left: 3px solid #dee2e6;
    padding-left: 0.5rem;
    margin-bottom: 1rem;
}

.classified-modules-list .category-header {
    font-size: 0.9rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.classified-module-item {
    background-color: #f8f9fa;
    border: 1px solid #e9ecef !important;
    border-radius: 0.375rem;
    transition: all 0.2s ease;
}

.classified-module-item:hover {
    background-color: #e9ecef;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.classified-module-item .module-name {
    color: #495057;
    font-weight: 600;
    font-size: 0.8rem;
}

.classified-module-item .module-desc {
    font-size: 0.75rem;
    line-height: 1.3;
    margin-top: 0.25rem;
}

/* 模块项卡片增强样式 */
.module-item-card.border-success {
    background-color: #f8fff9;
    border-color: #28a745 !important;
}

.module-item-card:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: all 0.2s ease;
}

/* 模块分类弹窗优化样式 */
#classifyModuleModal .modal-body {
    padding: 1rem 1.5rem;
}

#classifyModuleModal .mb-3 {
    margin-bottom: 0.75rem !important;
}

/* 优化模块描述输入框 */
#classifyModuleDescription {
    min-height: 60px; /* 设定最小高度 */
    max-height: 120px; /* 设定最大高度 */
    resize: vertical; /* 只允许垂直调整大小 */
    font-size: 0.9rem;
    line-height: 1.4;
    padding: 0.5rem 0.75rem;
    transition: height 0.2s ease, border-color 0.2s ease;
}

#classifyModuleDescription:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

/* 当描述为空时，减少高度 */
#classifyModuleDescription:placeholder-shown {
    min-height: 45px;
}

/* 模块分类弹窗整体紧凑化 */
#classifyModuleModal .form-label {
    margin-bottom: 0.3rem;
    font-weight: 500;
    font-size: 0.9rem;
}

#classifyModuleModal .form-control,
#classifyModuleModal .form-select {
    padding: 0.4rem 0.75rem;
    font-size: 0.9rem;
}

#classifyModuleModal .modal-footer {
    padding: 0.75rem 1.5rem;
}

/* 类列表样式 */
.class-item-card {
    background: #f8f9fa;
    transition: all 0.2s ease;
}

.class-item-card:hover {
    background: #e9ecef;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.class-name {
    font-family: 'Courier New', monospace;
    font-size: 0.85rem;
    font-weight: 600;
    color: #495057;
}

.class-action-btn {
    min-width: 32px;
    height: 32px;
    padding: 0;
    border-radius: 4px;
    transition: all 0.2s ease;
    border: none;
}

.class-action-btn:hover {
    transform: scale(1.1);
}

.class-action-btn.add-btn {
    background-color: #28a745;
    color: white;
}

.class-action-btn.remove-btn {
    background-color: #dc3545;
    color: white;
}

.class-action-btn:disabled {
    background-color: #6c757d !important;
    color: #adb5bd !important;
    cursor: not-allowed;
    opacity: 0.6;
}

.class-in-all {
    background-color: #d1ecf1;
    border-color: #bee5eb;
}

/* 模块风格样式 */
.style-item {
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    background: white;
}

.style-item:hover {
    border-color: #007bff;
    box-shadow: 0 2px 5px rgba(0,123,255,0.1);
}

.style-item.selected {
    border-color: #007bff;
    background-color: #f8f9ff;
    box-shadow: 0 2px 10px rgba(0,123,255,0.2);
}

.style-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
}

.style-description {
    color: #666;
    font-size: 0.9em;
    margin-bottom: 8px;
}

.style-preview-mini {
    background-color: #f8f9fa;
    border-radius: 4px;
    padding: 8px;
    overflow: hidden;
}

.style-preview-mini pre {
    margin: 0;
    font-size: 0.8em;
    color: #333;
}

.style-preview-container {
    max-height: 400px;
    overflow-y: auto;
}

.style-preview-full pre {
    font-size: 0.9em;
    max-height: 300px;
    overflow-y: auto;
}

.styles-list {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 10px;
}

/* 类列表选择状态 */
.class-item.selected {
    background-color: #e3f2fd;
    border-color: #2196f3;
    box-shadow: 0 2px 4px rgba(33, 150, 243, 0.2);
}

.class-item {
    cursor: pointer;
    transition: all 0.2s ease;
}

.class-item:hover {
    background-color: #f5f5f5;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.class-name-area {
    cursor: pointer;
    border-radius: 4px;
    padding: 4px;
    transition: background-color 0.2s;
}

.class-name-area:hover {
    background-color: #e3f2fd;
}

.class-item.selected .class-name-area {
    background-color: #bbdefb;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <!-- 文件信息 -->
            <div class="file-info-bar">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h4>
                            <i class="fas fa-file-code me-2"></i>{{ file_name }}
                        </h4>
                        <p class="mb-0">
                            <i class="fas fa-folder me-2"></i>{{ file_path }}
                            <span class="ms-3">
                                <i class="fas fa-weight me-1"></i>{{ file_size|filesizeformat }}
                            </span>
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <a href="{% url 'modules:list' %}" class="btn btn-outline-light me-2">
                            <i class="fas fa-arrow-left me-1"></i>返回列表
                        </a>
                        <button id="editBtn" class="btn btn-warning me-2" {% if not can_edit %}disabled title="文件正在被其他用户编辑"{% endif %} {% if is_editing %}style="display: none;"{% endif %}>
                            <i class="fas fa-edit me-1"></i>编辑
                        </button>
                        <button id="saveBtn" class="btn btn-success" {% if not is_editing %}style="display: none;"{% endif %}>
                            <i class="fas fa-save me-1"></i>保存
                        </button>
                        <button id="cancelBtn" class="btn btn-secondary" {% if not is_editing %}style="display: none;"{% endif %}>
                            <i class="fas fa-times me-1"></i>取消
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 编辑冲突警告 -->
            {% if active_sessions %}
                <div class="editing-warning">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>编辑冲突警告</h6>
                    <p class="mb-2">以下用户正在编辑此文件：</p>
                    <ul class="mb-0">
                        {% for session in active_sessions %}
                            <li>{{ session.user.username }} ({{ session.last_activity|timesince }}前)</li>
                        {% endfor %}
                    </ul>
                    <p class="mb-0 mt-2"><strong>为避免冲突，建议等待其他用户完成编辑后再进行修改。</strong></p>
                </div>
            {% endif %}
        </div>
    </div>
    
    <div class="row">
        <!-- 左侧编辑器 -->
        <div class="col-md-10">
            <!-- 编辑器 -->
            <div class="card">
                <div class="editor-toolbar">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <small class="text-muted">
                                <i class="fas fa-keyboard me-1"></i>
                                快捷键: Ctrl+S 保存, Ctrl+F 查找, Ctrl+Space 代码补全
                            </small>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-primary" id="loadTemplateBtn">
                                    <i class="fas fa-code me-1"></i>载入模板类
                                </button>
                                <button type="button" class="btn btn-outline-success" id="testBtn" onclick="testPythonFile()">
                                    <i class="fas fa-play me-1"></i>测试运行
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="formatBtn">
                                    <i class="fas fa-code me-1"></i>格式化
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="findBtn">
                                    <i class="fas fa-search me-1"></i>查找
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="fullscreenBtn">
                                    <i class="fas fa-expand me-1"></i>全屏
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="editor-container {% if is_editing %}edit-mode{% else %}readonly-mode{% endif %}" id="editorContainer">
                    <!-- 编辑器加载遮罩 -->
                    <div class="editor-loading-overlay" id="editorLoadingOverlay">
                        <div class="loading-content">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                            <div class="loading-text mt-3">
                                <h5>正在初始化编辑器...</h5>
                                <p class="text-muted">请稍候，代码编辑器正在加载中</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mode-indicator {% if is_editing %}edit{% else %}readonly{% endif %}" id="modeIndicator">
                        {% if is_editing %}编辑模式{% else %}只读模式{% endif %}
                    </div>
                    <textarea id="codeEditor" style="opacity: 0; visibility: hidden;">{{ file_content }}</textarea>
                </div>
            </div>
        </div>
        
        <!-- 右侧模块信息侧边栏 -->
        <div class="col-md-2">
            <div class="card module-info-sidebar">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-cubes me-2"></i>模块信息
                        {% if all_items %}
                            <span class="badge bg-light text-dark float-end">{{ all_items|length }}</span>
                        {% endif %}
                    </h6>
                </div>
                <div class="card-body p-2">
                    {% if all_items %}
                        <div class="mb-3">
                            <h6 class="text-muted mb-2">
                                <i class="fas fa-list me-1"></i>__all__ 字段模块
                            </h6>
                            <div class="module-items-list">
                                {% for item in all_items %}
                                <div class="module-item-card mb-2 p-2 border rounded">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <div class="module-name">{{ item }}</div>
                                            {% for module_item in module_items %}
                                                {% if module_item.name == item %}
                                                    <small class="text-success d-block">
                                                        <i class="fas fa-tag me-1"></i>
                                                        {{ module_item.get_category_display }}
                                                    </small>
                                                    {% if module_item.description %}
                                                        <small class="text-muted d-block">{{ module_item.description|truncatewords:6 }}</small>
                                                    {% endif %}
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                        <div class="module-actions">
                                            {% for module_item in module_items %}
                                                {% if module_item.name == item %}
                                                    <button class="btn btn-sm btn-outline-primary classify-btn" 
                                                            data-module-id="{{ module_item.id }}" 
                                                            data-module-name="{{ module_item.name }}"
                                                            data-current-category="{{ module_item.category }}"
                                                            data-current-description="{{ module_item.description|default:'' }}"
                                                            title="重新分类">
                                                        <i class="fas fa-tags"></i>
                                                    </button>
                                                {% endif %}
                                            {% empty %}
                                                <button class="btn btn-sm btn-outline-success add-module-btn" 
                                                        data-module-name="{{ item }}"
                                                        title="添加分类">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-info-circle fa-2x mb-2"></i>
                            <p class="mb-0 small">此文件没有 __all__ 字段</p>
                            <small>无法检测到可导出的模块</small>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- 类列表区域 -->
            <div class="card module-info-sidebar mt-3">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-cube me-2"></i>类列表
                        <span id="classCountBadge" class="badge bg-light text-dark float-end">0</span>
                    </h6>
                </div>
                <div class="card-body p-2">
                    <div id="classListContainer">
                        <div class="text-center text-muted py-3" id="noClassesMessage">
                            <i class="fas fa-search fa-2x mb-2"></i>
                            <p class="mb-0 small">正在分析类定义...</p>
                        </div>
                    </div>
                    <div class="mt-2">
                        <button class="btn btn-sm btn-outline-success w-100" onclick="analyzeAndUpdateClasses()">
                            <i class="fas fa-sync-alt me-1"></i>刷新类列表
                        </button>
                        <button class="btn btn-sm btn-outline-primary w-100 mt-1" onclick="showModuleStylesModal()" title="插入代码风格到当前类">
                            <i class="fas fa-palette me-1"></i>模块风格
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 保存状态提示 -->
<div id="saveStatus" class="save-status">
    <span id="saveStatusText"></span>
</div>

<!-- 测试结果模态框 -->
<div class="modal fade" id="testResultModal" tabindex="-1" aria-labelledby="testResultModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="testResultModalLabel">
                    <i class="fas fa-play-circle text-success me-2"></i>Python 文件测试结果
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        <i class="fas fa-file-code me-1"></i>测试文件:
                    </label>
                    <div class="alert alert-info py-2 px-3">
                        <code id="testFilePath">{{ file_path }}</code>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        <i class="fas fa-terminal me-1"></i>执行命令:
                    </label>
                    <div class="alert alert-secondary py-2 px-3">
                        <code id="testCommand">cd EOLO && uv run --quiet {{ file_path }}</code>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div id="testStatus" class="alert" style="display: none;">
                        <i class="fas fa-info-circle me-1"></i>
                        <span id="testStatusText"></span>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        <i class="fas fa-clipboard-list me-1"></i>输出结果:
                    </label>
                    <div class="border rounded" style="background-color: #1e1e1e; color: #d4d4d4; font-family: 'Courier New', monospace;">
                        <div class="d-flex justify-content-between align-items-center px-3 py-2 border-bottom" style="background-color: #2d2d30;">
                            <small class="text-muted">控制台输出</small>
                            <button type="button" class="btn btn-sm btn-outline-light" onclick="copyTestOutput()">
                                <i class="fas fa-copy me-1"></i>复制
                            </button>
                        </div>
                        <pre id="testOutput" class="p-3 m-0" style="max-height: 400px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word;">等待执行...</pre>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" onclick="testPythonFile()" id="retestBtn">
                    <i class="fas fa-redo me-1"></i>重新测试
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- 确认离开对话框 -->
<div class="modal fade" id="confirmLeaveModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">确认离开</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>文件有未保存的更改，确认要离开吗？</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirmLeaveBtn">确认离开</button>
            </div>
        </div>
    </div>
</div>

<!-- 模块分类对话框 -->
<div class="modal fade" id="classifyModuleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-tags me-2"></i>模块分类
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">模块名称</label>
                    <input type="text" class="form-control" id="classifyModuleName" readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label">选择分类</label>
                    <select class="form-select" id="classifyModuleCategory">
                        {% for value, label in categories %}
                            <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">模块描述（可选）</label>
                    <textarea class="form-control" id="classifyModuleDescription" rows="2" 
                              placeholder="请简要描述这个模块的功能..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirmClassifyBtn">确认分类</button>
            </div>
        </div>
    </div>
</div>

<!-- 载入模板类对话框 -->
<div class="modal fade" id="loadTemplateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-code me-2"></i>载入模板类
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>选择模板类</h6>
                        <div id="templatesList" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin"></i> 加载中...
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>模板预览</h6>
                        <div id="templatePreview" class="border rounded p-3 bg-light" style="max-height: 300px; overflow-y: auto;">
                            <div class="text-muted">请选择一个模板查看预览</div>
                        </div>
                    </div>
                </div>
                <div class="row mt-3" id="placeholderSection" style="display: none;">
                    <div class="col-12">
                        <h6>填写占位符</h6>
                        <div class="alert alert-info">
                            <small><i class="fas fa-info-circle me-1"></i>请为模板中的占位符（???）填写具体的值</small>
                        </div>
                        <div id="placeholderInputs">
                            <!-- 动态生成的占位符输入框 -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="insertTemplateBtn" disabled>
                    <i class="fas fa-plus me-1"></i>插入到代码
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 模块风格选择对话框 -->
<div class="modal fade" id="moduleStylesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-palette me-2"></i>选择模块风格
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>当前选中的类:</h6>
                        <div class="alert alert-info" id="selectedClassInfo">
                            <i class="fas fa-info-circle me-2"></i>
                            <span id="selectedClassName">请先选择一个类</span>
                        </div>
                        
                        <h6>可用的模块风格:</h6>
                        <div id="moduleStylesList" class="styles-list">
                            <div class="text-center">
                                <i class="fas fa-spinner fa-spin"></i> 加载风格列表...
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>风格预览:</h6>
                        <div id="stylePreviewContainer" class="style-preview-container">
                            <div class="alert alert-secondary text-center">
                                <i class="fas fa-eye-slash"></i>
                                <p class="mb-0">请选择一个风格来预览</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="insertStyleBtn" disabled>
                    <i class="fas fa-code me-1"></i>插入到类中
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}


{% block extra_js %}
<!-- CodeMirror JavaScript -->
<script src="{% static 'js/codemirror-5.65.0/lib/codemirror.js' %}"></script>
<script src="{% static 'js/codemirror-5.65.0/mode/python/python.js' %}"></script>
<script src="{% static 'js/codemirror-5.65.0/addon/hint/show-hint.js' %}"></script>
<!-- <script src="{% static 'js/codemirror-5.65.0/addon/hint/python-hint.js' %}"></script> -->
<script src="{% static 'js/codemirror-5.65.0/addon/search/searchcursor.js' %}"></script>
<script src="{% static 'js/codemirror-5.65.0/addon/search/search.js' %}"></script>
<script src="{% static 'js/codemirror-5.65.0/addon/dialog/dialog.js' %}"></script>
<!-- <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.0/lib/codemirror.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.0/mode/python/python.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.0/addon/hint/show-hint.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.0/addon/hint/python-hint.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.0/addon/search/searchcursor.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.0/addon/search/search.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.0/addon/dialog/dialog.min.js"></script> -->

<script>
// 全局变量定义
let isEditMode = {{ is_editing|yesno:"true,false" }};
let isModified = false;
let originalContent = '';
let editorInstance = null; // 存储CodeMirror实例

// 显示保存状态 - 全局函数
function showSaveStatus(message, type) {
    const statusDiv = document.getElementById('saveStatus');
    const statusText = document.getElementById('saveStatusText');
    
    statusText.textContent = message;
    statusDiv.className = `save-status ${type} show`;
    
    setTimeout(() => {
        statusDiv.classList.remove('show');
    }, 3000);
}

document.addEventListener('DOMContentLoaded', function() {
    
    // 获取DOM元素
    const textarea = document.getElementById('codeEditor');
    const loadingOverlay = document.querySelector('.editor-loading-overlay');
    
    // 显示加载遮罩，隐藏原始textarea
    if (loadingOverlay) {
        loadingOverlay.classList.remove('hidden');
    }
    if (textarea) {
        textarea.style.opacity = '0';
        textarea.style.visibility = 'hidden';
    }
    
    // 延迟初始化CodeMirror以确保平滑过渡
    setTimeout(function() {
        // 初始化CodeMirror编辑器（根据编辑状态设置）
        const editor = CodeMirror.fromTextArea(textarea, {
            mode: 'python',
            theme: 'monokai',
            lineNumbers: true,
            indentUnit: 4,
            indentWithTabs: false,
            readOnly: !isEditMode,  // 根据编辑状态设置
            extraKeys: {
                "Ctrl-Space": "autocomplete",
                "Ctrl-S": function(cm) {
                    if (isEditMode) saveFile();
                },
                "F11": function(cm) {
                    cm.setOption("fullScreen", !cm.getOption("fullScreen"));
                },
                "Esc": function(cm) {
                    if (cm.getOption("fullScreen")) cm.setOption("fullScreen", false);
                }
            },
            hintOptions: {
                hint: CodeMirror.hint.python
            }
        });
        
        // 存储编辑器实例到全局变量
        editorInstance = editor;
        window.editorInstance = editor; // 也存储在全局对象中
        
        originalContent = editor.getValue();
    
    // 立即隐藏加载遮罩，CodeMirror渲染很快
    setTimeout(function() {
        if (loadingOverlay) {
            loadingOverlay.classList.add('hidden');
        }
        const cmElement = editor.getWrapperElement();
        if (cmElement) {
            cmElement.classList.add('cm-ready');
            // 立即刷新编辑器确保正确显示
            editor.refresh();
        }
    }, 50); // 减少延迟到50ms
    
    // 备用隐藏机制，如果上面的没有生效
    setTimeout(function() {
        if (loadingOverlay && !loadingOverlay.classList.contains('hidden')) {
            loadingOverlay.classList.add('hidden');
            const cmElement = editor.getWrapperElement();
            if (cmElement) {
                cmElement.classList.add('cm-ready');
                editor.refresh();
            }
        }
    }, 200); // 减少备用延迟
    
    // 获取元素
    const editBtn = document.getElementById('editBtn');
    const saveBtn = document.getElementById('saveBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const editorContainer = document.getElementById('editorContainer');
    const modeIndicator = document.getElementById('modeIndicator');
    
    // 切换到编辑模式
    function enterEditMode() {
        // 首先检查权限
        const canEdit = {{ can_edit|yesno:"true,false" }};
        if (!canEdit) {
            showSaveStatus('文件正在被其他用户编辑，无法进入编辑模式', 'error');
            return;
        }
        
        // 显示加载状态
        editBtn.disabled = true;
        editBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>进入编辑...';
        
        // 调用API进入编辑模式
        fetch('/modules/api/enter-edit/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                file_path: '{{ file_path }}'
            })
        })
        .then(response => response.json())
        .then(data => {
            // 恢复按钮状态
            editBtn.disabled = false;
            editBtn.innerHTML = '<i class="fas fa-edit me-1"></i>编辑';
            
            if (data.success) {
                // 成功进入编辑模式
                isEditMode = true;
                editor.setOption('readOnly', false);
                editor.focus();
                
                // 更新按钮显示
                editBtn.style.display = 'none';
                saveBtn.style.display = 'inline-block';
                cancelBtn.style.display = 'inline-block';
                
                // 更新容器样式
                editorContainer.classList.remove('readonly-mode');
                editorContainer.classList.add('edit-mode');
                
                // 更新模式指示器
                modeIndicator.classList.remove('readonly');
                modeIndicator.classList.add('edit');
                modeIndicator.textContent = '编辑模式';
                
                // 确保深色主题
                editor.refresh();
                
                // 进入编辑模式时分析一次类列表
                setTimeout(() => {
                    analyzeAndUpdateClasses();
                }, 200);
                
                showSaveStatus('已进入编辑模式，可以修改文件内容', 'success');
            } else {
                // 处理编辑冲突或其他错误
                if (data.error === 'editing_conflict') {
                    let message = '以下用户正在编辑此文件：\n\n';
                    data.other_users.forEach(user => {
                        message += `${user.username} (${user.minutes_ago} 分钟前)\n`;
                    });
                    message += '\n为避免冲突，建议等待其他用户完成编辑后再进行修改。';
                    alert(message);
                } else {
                    showSaveStatus('进入编辑模式失败: ' + data.error, 'error');
                }
            }
        })
        .catch(error => {
            // 恢复按钮状态
            editBtn.disabled = false;
            editBtn.innerHTML = '<i class="fas fa-edit me-1"></i>编辑';
            
            console.error('进入编辑模式失败:', error);
            showSaveStatus('网络错误，无法进入编辑模式', 'error');
        });
    }
    
    // 退出编辑模式
    function exitEditMode() {
        // 调用API关闭编辑会话
        fetch('/modules/api/close-session/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                path: '{{ file_path }}'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('编辑会话已关闭');
            } else {
                console.error('关闭编辑会话失败:', data.error);
            }
        })
        .catch(error => {
            console.error('关闭编辑会话网络错误:', error);
        });
        
        // 更新界面状态
        isEditMode = false;
        isModified = false;
        editor.setOption('readOnly', true);
        
        // 重置内容为原始内容（避免显示未保存的修改）
        if (editor.getValue() !== originalContent) {
            editor.setValue(originalContent);
        }
        
        // 更新按钮显示
        editBtn.style.display = 'inline-block';
        editBtn.disabled = false;
        editBtn.innerHTML = '<i class="fas fa-edit me-1"></i>编辑';
        
        saveBtn.style.display = 'none';
        cancelBtn.style.display = 'none';
        
        // 更新容器样式
        editorContainer.classList.remove('edit-mode');
        editorContainer.classList.add('readonly-mode');
        
        // 更新模式指示器
        modeIndicator.classList.remove('edit');
        modeIndicator.classList.add('readonly');
        modeIndicator.innerHTML = '<i class="fas fa-eye me-1"></i>只读模式';
        
        // 确保编辑器刷新显示
        setTimeout(() => {
            editor.refresh();
        }, 100);
        
        // 退出编辑模式时分析一次类列表
        setTimeout(() => {
            analyzeAndUpdateClasses();
        }, 200);
        
        showSaveStatus('已退出编辑模式', 'success');
    }
    
    // 更新模块信息侧边栏显示
    function updateModuleInfoSidebar(data) {
        // 更新__all__字段模块显示
        const moduleInfoCard = document.querySelector('.module-info-sidebar .card-body');
        if (!moduleInfoCard) return;
        
        // 从当前编辑器内容中提取__all__项目
        const code = editorInstance ? editorInstance.getValue() : '';
        const allPattern = /__all__\s*=\s*\[(.*?)\]/s;
        const allMatch = allPattern.exec(code);
        const allItems = [];
        
        if (allMatch) {
            const itemPattern = /["']([^"']+)["']/g;
            let itemMatch;
            while ((itemMatch = itemPattern.exec(allMatch[1])) !== null) {
                allItems.push(itemMatch[1]);
            }
        }
        
        // 更新模块信息头部的徽章
        const badge = document.querySelector('.module-info-sidebar .card-header .badge');
        if (badge) {
            badge.textContent = allItems.length;
        }
        
        // 重新构建模块信息显示
        let newContent = '';
        
        if (allItems.length > 0) {
            newContent += `
                <div class="mb-3">
                    <h6 class="text-muted mb-2">
                        <i class="fas fa-list me-1"></i>__all__ 字段模块
                    </h6>
                    <div class="module-items-list">
            `;
            
            allItems.forEach(item => {
                newContent += `
                    <div class="module-item-card mb-2 p-2 border rounded">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="module-name">${item}</span>
                            <small class="text-muted">模块</small>
                        </div>
                    </div>
                `;
            });
            
            newContent += `
                    </div>
                </div>
            `;
        } else {
            newContent += `
                <div class="text-center text-muted py-3">
                    <i class="fas fa-info-circle mb-2"></i>
                    <p class="mb-0">该文件暂无__all__字段定义</p>
                    <small>或者__all__字段为空</small>
                </div>
            `;
        }
        
        moduleInfoCard.innerHTML = newContent;
    }
    
    // 监听内容变化
    editor.on('change', function(cm, change) {
        if (change.origin !== 'setValue' && isEditMode) {
            isModified = (cm.getValue() !== originalContent);
            updateSaveButton();
            
            // 不再实时分析类列表变化，只在保存时和加载时分析
        }
    });
    
    // 更新保存按钮状态
    function updateSaveButton() {
        if (isModified && isEditMode) {
            saveBtn.classList.remove('btn-success');
            saveBtn.classList.add('btn-warning');
            saveBtn.innerHTML = '<i class="fas fa-save me-1"></i>保存*';
        } else {
            saveBtn.classList.remove('btn-warning');
            saveBtn.classList.add('btn-success');
            saveBtn.innerHTML = '<i class="fas fa-save me-1"></i>保存';
        }
    }
    
    // 保存文件
    function saveFile() {
        if (!isEditMode) {
            showSaveStatus('请先点击编辑按钮进入编辑模式', 'error');
            return;
        }
        
        const canEdit = {{ can_edit|yesno:"true,false" }};
        if (!canEdit) {
            showSaveStatus('无法保存：文件正在被其他用户编辑', 'error');
            return;
        }
        
        const content = editor.getValue();
        
        // 显示保存中状态
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>保存中...';
        
        fetch('/modules/api/save/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                path: '{{ file_path }}',
                content: content
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                originalContent = content;
                isModified = false;
                showSaveStatus('保存成功，已退出编辑模式', 'success');
                // 保存成功后自动退出编辑模式
                exitEditMode();
                // 不刷新页面，直接重新分析模块信息并更新侧边栏和类列表
                refreshModuleInfo(); // 这会重新加载页面，确保显示更新
            } else {
                showSaveStatus('保存失败: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('保存错误:', error);
            showSaveStatus('保存失败: 网络错误', 'error');
        })
        .finally(() => {
            saveBtn.disabled = false;
            updateSaveButton();
        });
    }
    
    // 工具栏按钮事件
    editBtn.addEventListener('click', function() {
        const canEdit = {{ can_edit|yesno:"true,false" }};
        if (canEdit) {
            enterEditMode();
        } else {
            showSaveStatus('无法编辑：文件正在被其他用户编辑', 'error');
        }
    });
    
    saveBtn.addEventListener('click', saveFile);
    
    // 刷新模块信息（带页面重载）
    function refreshModuleInfo() {
        const filePath = '{{ file_path }}';
        if (!filePath) return;
        
        // 显示同步状态
        showSaveStatus('正在同步模块信息...', 'info');
        
        // 重新分析文件的__all__字段
        fetch('/modules/api/analyze-file/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                file_path: filePath
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 显示同步结果
                if (data.total_changes > 0) {
                    let changeDetails = [];
                    if (data.added_modules && data.added_modules.length > 0) {
                        changeDetails.push(`新增${data.added_modules.length}个模块`);
                    }
                    if (data.updated_modules && data.updated_modules.length > 0) {
                        changeDetails.push(`更新${data.updated_modules.length}个模块`);
                    }
                    if (data.deleted_modules && data.deleted_modules.length > 0) {
                        changeDetails.push(`删除${data.deleted_modules.length}个模块`);
                    }
                    showSaveStatus(`模块同步完成: ${changeDetails.join('，')}`, 'success');
                } else {
                    showSaveStatus('模块信息无变化', 'success');
                }
                
                // 短暂延迟后重新加载页面以更新模块信息
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showSaveStatus('同步模块信息失败: ' + data.error, 'error');
                console.error('分析文件失败:', data.error);
            }
        })
        .catch(error => {
            showSaveStatus('同步模块信息失败: 网络错误', 'error');
            console.error('分析文件错误:', error);
        });
    }
    
    // 刷新模块信息（不重载页面）
    function refreshModuleInfoWithoutReload() {
        const filePath = '{{ file_path }}';
        if (!filePath) return;
        
        // 显示同步状态
        showSaveStatus('正在同步模块信息...', 'info');
        
        // 重新分析文件的__all__字段
        fetch('/modules/api/analyze-file/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                file_path: filePath
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 显示同步结果
                if (data.total_changes > 0) {
                    let changeDetails = [];
                    if (data.added_modules && data.added_modules.length > 0) {
                        changeDetails.push(`新增${data.added_modules.length}个模块`);
                    }
                    if (data.updated_modules && data.updated_modules.length > 0) {
                        changeDetails.push(`更新${data.updated_modules.length}个模块`);
                    }
                    if (data.deleted_modules && data.deleted_modules.length > 0) {
                        changeDetails.push(`删除${data.deleted_modules.length}个模块`);
                    }
                    showSaveStatus(`模块同步完成: ${changeDetails.join('，')}`, 'success');
                } else {
                    showSaveStatus('模块信息无变化', 'success');
                }
                
                // 更新模块信息侧边栏显示
                if (typeof updateModuleInfoSidebar === 'function') {
                    updateModuleInfoSidebar(data);
                }
                
                // 重新分析类列表（使用保存后的内容）
                setTimeout(() => {
                    analyzeAndUpdateClasses();
                }, 500);
            } else {
                showSaveStatus('同步模块信息失败: ' + data.error, 'error');
                console.error('分析文件失败:', data.error);
            }
        })
        .catch(error => {
            showSaveStatus('同步模块信息失败: 网络错误', 'error');
            console.error('分析文件错误:', error);
        });
    }
    
    // 更新模块信息侧边栏显示
    function updateModuleInfoSidebar(data) {
        // 重新获取完整的模块信息，包括已分类的模块
        refreshCompleteModuleInfo();
    }
    
    // 完整刷新模块信息侧边栏
    function refreshCompleteModuleInfo() {
        const filePath = '{{ file_path }}';
        if (!filePath) {
            console.log('没有文件路径，跳过模块信息刷新');
            return;
        }
        
        console.log('开始刷新模块信息，文件路径:', filePath);
        
        // 获取当前文件的所有模块信息
        fetch('/modules/api/modules-by-category/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            console.log('API响应状态:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('API返回数据:', data);
            if (data.success) {
                updateModuleInfoDisplay(data.modules_by_category, filePath);
            } else {
                console.error('API返回错误:', data.error);
            }
        })
        .catch(error => {
            console.error('获取模块信息失败:', error);
        });
    }
    
    // 更新模块信息显示
    function updateModuleInfoDisplay(modulesByCategory, currentFilePath) {
        console.log('开始更新模块信息显示');
        console.log('当前文件路径:', currentFilePath);
        console.log('分类数据:', modulesByCategory);
        
        const moduleInfoCard = document.querySelector('.module-info-sidebar:first-child .card-body');
        if (!moduleInfoCard) {
            console.error('找不到模块信息卡片');
            return;
        }
        
        console.log('找到模块信息卡片:', moduleInfoCard);
        
        // 从当前编辑器内容中提取__all__项目
        const code = window.editor ? window.editor.getValue() : (window.editorInstance ? window.editorInstance.getValue() : '');
        console.log('当前编辑器代码长度:', code.length);
        
        const allPattern = /__all__\s*=\s*\[(.*?)\]/s;
        const allMatch = allPattern.exec(code);
        const allItems = [];
        
        if (allMatch) {
            const itemPattern = /["']([^"']+)["']/g;
            let itemMatch;
            while ((itemMatch = itemPattern.exec(allMatch[1])) !== null) {
                allItems.push(itemMatch[1]);
            }
        }
        
        console.log('提取到的__all__项目:', allItems);
        
        // 更新模块信息头部的徽章
        const badge = document.querySelector('.module-info-sidebar:first-child .card-header .badge');
        if (badge) {
            badge.textContent = allItems.length;
            console.log('更新了徽章数字:', allItems.length);
        }
        
        // 找到当前文件的已分类模块
        let classifiedModules = [];
        Object.keys(modulesByCategory).forEach(category => {
            const categoryInfo = modulesByCategory[category];
            if (categoryInfo.modules) {
                categoryInfo.modules.forEach(module => {
                    if (module.file_path === currentFilePath) {
                        classifiedModules.push({
                            ...module,
                            category: category,
                            category_info: categoryInfo
                        });
                    }
                });
            }
        });
        
        console.log('找到的已分类模块:', classifiedModules);
        
        // 简化的内容构建
        let newContent = `<div class="text-center text-muted py-3">
            <i class="fas fa-sync-alt fa-spin fa-2x mb-2"></i>
            <p class="mb-0 small">模块信息已更新</p>
            <small>__all__ 模块: ${allItems.length} 个</small>
            <br><small>已分类模块: ${classifiedModules.length} 个</small>
        </div>`;
        
        if (allItems.length > 0) {
            newContent += '<div class="mt-3"><strong>__all__ 模块:</strong><br>';
            allItems.forEach(item => {
                const classified = classifiedModules.find(m => m.name === item);
                newContent += `<span class="badge bg-${classified ? 'success' : 'secondary'} me-1 mb-1">${item}</span>`;
            });
            newContent += '</div>';
        }
        
        // 更新内容
        moduleInfoCard.innerHTML = newContent;
        console.log('模块信息显示更新完成');
    }
    
    cancelBtn.addEventListener('click', function() {
        if (isModified) {
            if (confirm('文件有未保存的更改，确认要取消编辑吗？')) {
                exitEditMode();
            }
        } else {
            exitEditMode();
        }
    });
    
    document.getElementById('formatBtn').addEventListener('click', function() {
        // 简单的Python代码格式化（基本缩进整理）
        const content = editor.getValue();
        // 这里可以集成更高级的格式化工具
        showSaveStatus('格式化功能待实现', 'error');
    });
    
    document.getElementById('findBtn').addEventListener('click', function() {
        CodeMirror.commands.find(editor);
    });
    
    document.getElementById('fullscreenBtn').addEventListener('click', function() {
        editor.setOption("fullScreen", !editor.getOption("fullScreen"));
    });
    
    // 页面离开前检查
    window.addEventListener('beforeunload', function(e) {
        if (isModified && isEditMode) {
            e.preventDefault();
            e.returnValue = '文件有未保存的更改，确认要离开吗？';
            return e.returnValue;
        }
    });
    
    // 关闭编辑会话（页面卸载时）
    window.addEventListener('beforeunload', function() {
        if (navigator.sendBeacon) {
            const formData = new FormData();
            formData.append('path', '{{ file_path }}');
            
            navigator.sendBeacon('/modules/api/close-session/', formData);
        }
    });
    
    // 定期更新会话活跃状态
    setInterval(function() {
        fetch('/modules/api/close-session/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                path: '{{ file_path }}',
                action: 'keep_alive'
            })
        });
    }, 30000); // 每30秒更新一次
    
    // Python文件测试功能
    function testPythonFile() {
        // 显示模态框
        const modal = new bootstrap.Modal(document.getElementById('testResultModal'));
        modal.show();
        
        // 重置状态
        document.getElementById('testStatus').style.display = 'none';
        document.getElementById('testOutput').textContent = '正在执行测试...';
        
        // 更新按钮状态
        const testBtn = document.getElementById('testBtn');
        const retestBtn = document.getElementById('retestBtn');
        const originalHtml = testBtn.innerHTML;
        
        testBtn.disabled = true;
        retestBtn.disabled = true;
        testBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>测试中...';
        retestBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>测试中...';
        
        // 发送测试请求
        fetch('/modules/api/test-python/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                file_path: '{{ file_path }}'
            })
        })
        .then(response => response.json())
        .then(data => {
            // 恢复按钮状态
            testBtn.disabled = false;
            retestBtn.disabled = false;
            testBtn.innerHTML = originalHtml;
            retestBtn.innerHTML = '<i class="fas fa-redo me-1"></i>重新测试';
            
            // 显示结果
            if (data.success) {
                // 显示状态
                const statusDiv = document.getElementById('testStatus');
                const statusText = document.getElementById('testStatusText');
                
                if (data.exit_code === 0) {
                    statusDiv.className = 'alert alert-success';
                    statusText.innerHTML = '<i class="fas fa-check-circle me-1"></i>执行成功 (退出码: 0)';
                } else {
                    statusDiv.className = 'alert alert-warning';
                    statusText.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>执行完成但有错误 (退出码: ' + data.exit_code + ')';
                }
                statusDiv.style.display = 'block';
                
                // 显示输出
                const output = data.output || '(无输出)';
                document.getElementById('testOutput').textContent = output;
                
                // 更新命令显示
                document.getElementById('testCommand').textContent = data.command || 'cd EOLO && uv run --quiet {{ file_path }}';
            } else {
                // 显示错误状态
                const statusDiv = document.getElementById('testStatus');
                const statusText = document.getElementById('testStatusText');
                
                statusDiv.className = 'alert alert-danger';
                statusText.innerHTML = '<i class="fas fa-times-circle me-1"></i>执行失败';
                statusDiv.style.display = 'block';
                
                // 显示错误信息
                document.getElementById('testOutput').textContent = data.error || '未知错误';
            }
        })
        .catch(error => {
            // 恢复按钮状态
            testBtn.disabled = false;
            retestBtn.disabled = false;
            testBtn.innerHTML = originalHtml;
            retestBtn.innerHTML = '<i class="fas fa-redo me-1"></i>重新测试';
            
            // 显示网络错误
            const statusDiv = document.getElementById('testStatus');
            const statusText = document.getElementById('testStatusText');
            
            statusDiv.className = 'alert alert-danger';
            statusText.innerHTML = '<i class="fas fa-times-circle me-1"></i>网络错误';
            statusDiv.style.display = 'block';
            
            document.getElementById('testOutput').textContent = '网络请求失败: ' + error.message;
        });
    }
    
    // 复制测试输出
    function copyTestOutput() {
        const output = document.getElementById('testOutput').textContent;
        navigator.clipboard.writeText(output).then(function() {
            // 显示复制成功提示
            showToast('输出内容已复制到剪贴板', 'success');
        }).catch(function(err) {
            console.error('复制失败:', err);
            showToast('复制失败', 'error');
        });
    }
    
    // 显示提示消息
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} border-0`;
        toast.style.position = 'fixed';
        toast.style.top = '20px';
        toast.style.right = '20px';
        toast.style.zIndex = '9999';
        
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'times-circle' : 'info-circle'} me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.parentElement.parentElement.remove()"></button>
            </div>
        `;
        
        document.body.appendChild(toast);
        
        // 3秒后自动移除
        setTimeout(() => {
            if (toast.parentElement) {
                toast.remove();
            }
        }, 3000);
    }
    
    // 将函数暴露到全局作用域
    window.testPythonFile = testPythonFile;
    window.copyTestOutput = copyTestOutput;
    
    // 模块分类相关功能
    let currentModuleForClassify = null;
    const classifyModal = new bootstrap.Modal(document.getElementById('classifyModuleModal'));
    
    // 动态调整描述输入框高度的全局函数
    window.adjustTextareaHeight = function() {
        const textarea = document.getElementById('classifyModuleDescription');
        if (!textarea) return;
        
        if (textarea.value.trim() === '') {
            // 如果为空，使用最小高度
            textarea.style.height = '45px';
        } else {
            // 如果有内容，自动调整高度
            textarea.style.height = 'auto';
            const scrollHeight = textarea.scrollHeight;
            const minHeight = 45;
            const maxHeight = 120;
            const newHeight = Math.min(Math.max(scrollHeight, minHeight), maxHeight);
            textarea.style.height = newHeight + 'px';
        }
    };
    
    // 为描述输入框绑定事件监听器
    const classifyDescriptionTextarea = document.getElementById('classifyModuleDescription');
    if (classifyDescriptionTextarea) {
        classifyDescriptionTextarea.addEventListener('input', window.adjustTextareaHeight);
        classifyDescriptionTextarea.addEventListener('focus', window.adjustTextareaHeight);
        classifyDescriptionTextarea.addEventListener('blur', window.adjustTextareaHeight);
        
        // 初始调整
        window.adjustTextareaHeight();
    }
    
    // 处理分类按钮点击
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('classify-btn') || 
            e.target.closest('.classify-btn')) {
            
            const btn = e.target.classList.contains('classify-btn') ? 
                        e.target : e.target.closest('.classify-btn');
            
            const moduleId = btn.getAttribute('data-module-id');
            const moduleName = btn.getAttribute('data-module-name');
            const currentCategory = btn.getAttribute('data-current-category');
            const currentDescription = btn.getAttribute('data-current-description') || '';
            
            currentModuleForClassify = {
                id: moduleId,
                name: moduleName,
                category: currentCategory
            };
            
            // 填充模态框
            document.getElementById('classifyModuleName').value = moduleName;
            document.getElementById('classifyModuleCategory').value = currentCategory || 'other';
            document.getElementById('classifyModuleDescription').value = currentDescription;
            
            // 调整描述框高度
            if (typeof window.adjustTextareaHeight === 'function') {
                setTimeout(window.adjustTextareaHeight, 100);
            }
            
            classifyModal.show();
        }
        
        // 处理添加新模块按钮
        if (e.target.classList.contains('add-module-btn') || e.target.closest('.add-module-btn')) {
            const btn = e.target.classList.contains('add-module-btn') ? 
                        e.target : e.target.closest('.add-module-btn');
            
            const moduleName = btn.getAttribute('data-module-name');
            
            currentModuleForClassify = {
                id: null,
                name: moduleName,
                category: 'other'
            };
            
            // 填充模态框
            document.getElementById('classifyModuleName').value = moduleName;
            document.getElementById('classifyModuleCategory').value = 'other';
            document.getElementById('classifyModuleDescription').value = '';
            
            // 调整描述框高度
            if (typeof window.adjustTextareaHeight === 'function') {
                setTimeout(window.adjustTextareaHeight, 100);
            }
            
            classifyModal.show();
        }
    });
    
    // 确认分类按钮点击
    document.getElementById('confirmClassifyBtn').addEventListener('click', function() {
        if (!currentModuleForClassify) return;
        
        const category = document.getElementById('classifyModuleCategory').value;
        const description = document.getElementById('classifyModuleDescription').value;
        
        // 调用分类API
        classifyModule(currentModuleForClassify.id, category, description);
    });
    
    // 分类模块函数
    function classifyModule(moduleId, category, description) {
        const btn = document.getElementById('confirmClassifyBtn');
        const originalText = btn.innerHTML;
        
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>分类中...';
        
        fetch('/modules/api/classify-module/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                module_id: moduleId,
                category: category,
                description: description
            })
        })
        .then(response => response.json())
        .then(data => {
            btn.disabled = false;
            btn.innerHTML = originalText;
            
            if (data.success) {
                showNotification(data.message, 'success');
                classifyModal.hide();
                // 刷新模块信息显示，不重新加载整个页面
                setTimeout(() => {
                    refreshModuleInfo(); // 使用带页面重载的方法确保更新
                }, 500);
            } else {
                showNotification('分类失败: ' + data.error, 'error');
            }
        })
        .catch(error => {
            btn.disabled = false;
            btn.innerHTML = originalText;
            console.error('分类错误:', error);
            showNotification('分类失败: 网络错误', 'error');
        });
    }
    
    // 获取CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // 显示通知
    function showNotification(message, type) {
        const toast = document.createElement('div');
        toast.className = `position-fixed top-0 end-0 m-3 alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
        toast.style.zIndex = '9999';
        toast.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(toast);
        
        // 3秒后自动移除
        setTimeout(() => {
            if (toast.parentElement) {
                toast.remove();
            }
        }, 3000);
    }
    
    }, 50); // 将初始化延迟从150ms减少到50ms，加快编辑器加载速度
    
    // 页面加载完成后分析一次类定义
    setTimeout(() => {
        analyzeAndUpdateClasses();
    }, 1000);
});

// 类分析和管理功能
let currentClasses = [];
let allItems = [];

// 分析并更新类列表
function analyzeAndUpdateClasses() {
    // 检查编辑器是否存在
    if (!editorInstance) {
        return;
    }
    
    try {
        // 获取代码内容 - 使用CodeMirror的getValue方法
        const code = editorInstance.getValue();
        
        // 增强的类定义正则表达式，支持多行类定义和装饰器
        // 这个正则表达式与insertStyleToClass函数中使用的保持一致
        const classPattern = /^(?:\s*@.*\n)*\s*class\s+([A-Za-z_][A-Za-z0-9_]*)\s*(?:\([^)]*\))?:/gm;
        const classes = [];
        let match;
        
        console.log('开始分析类定义，代码长度:', code.length);
        
        while ((match = classPattern.exec(code)) !== null) {
            const className = match[1];
            if (!classes.includes(className)) { // 避免重复
                classes.push(className);
                console.log('发现类:', className);
            }
        }
        
        console.log('共发现', classes.length, '个类:', classes);
        
        // 分析__all__内容
        const allPattern = /__all__\s*=\s*\[(.*?)\]/s;
        const allMatch = allPattern.exec(code);
        const allList = [];
        
        if (allMatch) {
            const itemPattern = /["']([^"']+)["']/g;
            let itemMatch;
            while ((itemMatch = itemPattern.exec(allMatch[1])) !== null) {
                allList.push(itemMatch[1]);
            }
        }
        
        currentClasses = classes;
        allItems = allList;
        
        console.log('分析完成 - 类:', currentClasses, '__all__项:', allItems);
        updateClassListDisplay();
        
    } catch (error) {
        console.error('类分析过程中发生错误:', error);
        showAlert('类分析失败: ' + error.message, 'error');
    }
}

// 更新类列表显示
function updateClassListDisplay() {
    const container = document.getElementById('classListContainer');
    const badge = document.getElementById('classCountBadge');
    
    if (!container || !badge) {
        return;
    }
    
    badge.textContent = currentClasses.length;
    
    if (currentClasses.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-3" id="noClassesMessage">
                <i class="fas fa-info-circle fa-2x mb-2"></i>
                <p class="mb-0 small">此文件中没有定义类</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    currentClasses.forEach(className => {
        const isInAll = allItems.includes(className);
        const cardClass = isInAll ? 'class-item class-item-card mb-2 p-2 border rounded class-in-all' : 'class-item class-item-card mb-2 p-2 border rounded';
        const buttonClass = isInAll ? 'class-action-btn remove-btn' : 'class-action-btn add-btn';
        const buttonIcon = isInAll ? 'fas fa-minus' : 'fas fa-plus';
        const buttonTitle = isInAll ? '从__all__中删除' : '添加到__all__';
        const buttonAction = isInAll ? `removeFromAll('${className}')` : `addToAll('${className}')`;
        
        html += `
            <div class="${cardClass}" data-class-name="${className}">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="flex-grow-1 class-name-area" onclick="selectClass('${className}')">
                        <div class="class-name" title="${className}">
                            <i class="fas fa-cube text-primary me-1"></i>
                            <strong>${className}</strong>
                            ${isInAll ? '<small class="text-success ms-2">(已在__all__中)</small>' : ''}
                        </div>
                        <small class="text-muted">点击选择此类</small>
                    </div>
                    <div class="class-actions">
                        <button class="${buttonClass}" 
                                onclick="${buttonAction}"
                                title="${buttonTitle}"
                                ${!isEditMode ? 'disabled' : ''}>
                            <i class="${buttonIcon}"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// 添加类到__all__
function addToAll(className) {
    // 检查是否在编辑模式
    if (!isEditMode) {
        showSaveStatus('请先进入编辑模式才能修改__all__字段', 'error');
        return;
    }
    
    if (!editorInstance) {
        showSaveStatus('编辑器未初始化', 'error');
        return;
    }
    
    // 获取代码内容 - 使用CodeMirror的getValue方法
    const code = editorInstance.getValue();
    const allPattern = /__all__\s*=\s*\[(.*?)\]/s;
    const match = allPattern.exec(code);
    
    if (match) {
        // 已存在__all__字段
        const currentItems = match[1];
        let newItems;
        
        if (currentItems.trim() === '') {
            newItems = `"${className}"`;
        } else {
            newItems = currentItems.trim();
            if (newItems.endsWith(',')) {
                newItems += ` "${className}"`;
            } else {
                newItems += `, "${className}"`;
            }
        }
        
        const newCode = code.replace(allPattern, `__all__ = [${newItems}]`);
        editorInstance.setValue(newCode); // 使用CodeMirror的setValue方法
        
    } else {
        // 不存在__all__字段，在文件开头添加
        const lines = code.split('\n');
        let insertIndex = 0;
        
        // 跳过文档字符串和导入语句
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (line.startsWith('"""') || line.startsWith("'''") || 
                line.startsWith('import ') || line.startsWith('from ') ||
                line.startsWith('#') || line === '') {
                insertIndex = i + 1;
            } else {
                break;
            }
        }
        
        const allLine = `__all__ = ["${className}"]`;
        lines.splice(insertIndex, 0, '', allLine);
        
        const newCode = lines.join('\n');
        editorInstance.setValue(newCode); // 使用CodeMirror的setValue方法
    }
    
    showSaveStatus(`已将类 "${className}" 添加到__all__字段`, 'success');
    
    // 重新分析并更新显示
    setTimeout(analyzeAndUpdateClasses, 100);
}

// 从__all__中删除类
function removeFromAll(className) {
    // 检查是否在编辑模式
    if (!isEditMode) {
        showSaveStatus('请先进入编辑模式才能修改__all__字段', 'error');
        return;
    }
    
    if (!editorInstance) {
        showSaveStatus('编辑器未初始化', 'error');
        return;
    }
    
    // 获取代码内容 - 使用CodeMirror的getValue方法
    const code = editorInstance.getValue();
    const allPattern = /__all__\s*=\s*\[(.*?)\]/s;
    const match = allPattern.exec(code);
    
    if (!match) {
        showSaveStatus('未找到__all__字段', 'error');
        return;
    }
    
    const currentItems = match[1];
    const itemPattern = /["']([^"']+)["']/g;
    const items = [];
    let itemMatch;
    
    while ((itemMatch = itemPattern.exec(currentItems)) !== null) {
        if (itemMatch[1] !== className) {
            items.push(`"${itemMatch[1]}"`);
        }
    }
    
    const newItems = items.join(', ');
    const newCode = code.replace(allPattern, `__all__ = [${newItems}]`);
    editorInstance.setValue(newCode); // 使用CodeMirror的setValue方法
    
    showSaveStatus(`已从__all__字段中删除类 "${className}"`, 'success');
    
    // 重新分析并更新显示
    setTimeout(analyzeAndUpdateClasses, 100);
}

// 选择类（用于模块风格功能）
function selectClass(className) {
    // 移除之前的选中状态
    document.querySelectorAll('.class-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    // 添加选中状态到当前项
    const classItem = document.querySelector(`.class-item[data-class-name="${className}"]`);
    if (classItem) {
        classItem.classList.add('selected');
        currentSelectedClass = {
            name: className,
            element: classItem
        };
        
        // 显示选中提示
        showAlert(`已选择类: ${className}`, 'success');
    }
}

// =============== 模板类载入功能 ===============

// 模板类相关变量
let availableTemplates = [];
let selectedTemplate = null;

// 载入模板类按钮点击事件
document.getElementById('loadTemplateBtn').addEventListener('click', function() {
    if (!isEditMode) {
        showSaveStatus('请先进入编辑模式才能载入模板类', 'error');
        return;
    }
    
    loadAvailableTemplates();
    const modal = new bootstrap.Modal(document.getElementById('loadTemplateModal'));
    modal.show();
});

// 加载可用模板列表
function loadAvailableTemplates() {
    const templatesList = document.getElementById('templatesList');
    templatesList.innerHTML = '<div class="text-center text-muted"><i class="fas fa-spinner fa-spin"></i> 加载中...</div>';
    
    fetch('/modules/api/templates/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                availableTemplates = data.templates;
                renderTemplatesList();
            } else {
                templatesList.innerHTML = '<div class="text-center text-muted">加载模板失败: ' + data.error + '</div>';
            }
        })
        .catch(error => {
            console.error('加载模板错误:', error);
            templatesList.innerHTML = '<div class="text-center text-muted">网络错误，无法加载模板</div>';
        });
}

// 渲染模板列表
function renderTemplatesList() {
    const templatesList = document.getElementById('templatesList');
    
    if (availableTemplates.length === 0) {
        templatesList.innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-exclamation-circle fa-2x mb-2"></i>
                <p>暂无可用模板</p>
                <p class="small">请先在模块管理页面添加模板类</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    availableTemplates.forEach(template => {
        html += `
            <div class="template-item p-2 mb-2 border rounded cursor-pointer" 
                 data-template-id="${template.id}" 
                 onclick="selectTemplate(${template.id})">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1 text-primary">${escapeHtml(template.name)}</h6>
                        <small class="text-muted">${escapeHtml(template.description || '无描述')}</small>
                    </div>
                    <div class="text-end">
                        <small class="text-muted">使用 ${template.usage_count} 次</small>
                    </div>
                </div>
            </div>
        `;
    });
    
    templatesList.innerHTML = html;
}

// 选择模板
function selectTemplate(templateId) {
    // 移除之前的选中状态
    document.querySelectorAll('.template-item').forEach(item => {
        item.classList.remove('bg-primary', 'text-white');
    });
    
    // 添加选中状态
    const selectedItem = document.querySelector(`[data-template-id="${templateId}"]`);
    if (selectedItem) {
        selectedItem.classList.add('bg-primary', 'text-white');
    }
    
    // 获取选中的模板
    selectedTemplate = availableTemplates.find(t => t.id === templateId);
    if (!selectedTemplate) return;
    
    // 显示模板预览
    showTemplatePreview(selectedTemplate);
    
    // 生成占位符输入框
    generatePlaceholderInputs(selectedTemplate);
    
    // 启用插入按钮
    document.getElementById('insertTemplateBtn').disabled = false;
}

// 显示模板预览
function showTemplatePreview(template) {
    const preview = document.getElementById('templatePreview');
    preview.innerHTML = `
        <h6 class="text-primary mb-2">${escapeHtml(template.name)}</h6>
        <p class="text-muted small mb-3">${escapeHtml(template.description || '无描述')}</p>
        <pre class="text-dark small mb-0"><code>${escapeHtml(template.code_content)}</code></pre>
    `;
}

// 生成占位符输入框
function generatePlaceholderInputs(template) {
    const placeholderSection = document.getElementById('placeholderSection');
    const placeholderInputs = document.getElementById('placeholderInputs');
    
    // 分析占位符
    const placeholders = extractPlaceholders(template.code_content);
    
    if (placeholders.length === 0) {
        placeholderSection.style.display = 'none';
        return;
    }
    
    placeholderSection.style.display = 'block';
    
    // 获取当前文件中的类名列表作为建议
    const existingClasses = currentClasses || [];
    
    let html = '';
    placeholders.forEach((placeholder, index) => {
        const placeholderName = placeholder || 'default';
        const placeholderLabel = placeholderName === 'default' ? '类名/默认值' : placeholderName;
        
        html += `
            <div class="mb-3">
                <label class="form-label">
                    ${placeholderLabel} <span class="text-danger">*</span>
                    <small class="text-muted">(替换占位符: ???${placeholder})</small>
                </label>
                <div class="input-group">
                    <input type="text" class="form-control" id="placeholder_${index}" 
                           placeholder="请输入${placeholderLabel}" required>
                    ${existingClasses.length > 0 ? `
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" 
                            data-bs-toggle="dropdown">选择现有类</button>
                    <ul class="dropdown-menu">
                        ${existingClasses.map(className => 
                            `<li><a class="dropdown-item" onclick="fillPlaceholder(${index}, '${className}')">${className}</a></li>`
                        ).join('')}
                    </ul>
                    ` : ''}
                </div>
            </div>
        `;
    });
    
    placeholderInputs.innerHTML = html;
}

// 提取占位符
function extractPlaceholders(codeContent) {
    const matches = [...codeContent.matchAll(/\?\?\?(\w*)/g)];
    const placeholders = [];
    const seen = new Set();
    
    matches.forEach(match => {
        const placeholder = match[1] || '';
        if (!seen.has(placeholder)) {
            placeholders.push(placeholder);
            seen.add(placeholder);
        }
    });
    
    return placeholders;
}

// 填充占位符输入框
function fillPlaceholder(index, value) {
    const input = document.getElementById(`placeholder_${index}`);
    if (input) {
        input.value = value;
    }
}

// 插入模板到代码
document.getElementById('insertTemplateBtn').addEventListener('click', function() {
    if (!selectedTemplate || !editorInstance) return;
    
    // 收集占位符替换值
    const placeholders = extractPlaceholders(selectedTemplate.code_content);
    const replacements = {};
    let hasError = false;
    
    placeholders.forEach((placeholder, index) => {
        const input = document.getElementById(`placeholder_${index}`);
        if (input) {
            const value = input.value.trim();
            if (!value) {
                showSaveStatus(`请填写${placeholder || '默认'}占位符`, 'error');
                hasError = true;
                return;
            }
            
            if (placeholder === '') {
                replacements['default'] = value;
            } else {
                replacements[placeholder] = value;
            }
        }
    });
    
    if (hasError) return;
    
    // 应用模板
    let processedCode = selectedTemplate.code_content;
    
    // 替换占位符
    for (const [key, value] of Object.entries(replacements)) {
        if (key === 'default') {
            processedCode = processedCode.replace(/\?\?\?(?!\w)/g, value);
        } else {
            processedCode = processedCode.replace(new RegExp(`\\?\\?\\?${key}`, 'g'), value);
        }
    }
    
    // 找到合适的插入位置（在其他类定义的后面，但在if __name__之前）
    const currentCode = editorInstance.getValue();
    const insertPosition = findClassInsertPosition(currentCode);
    
    // 插入代码
    const cursor = editorInstance.getCursor();
    const line = insertPosition.line;
    const beforeText = insertPosition.line > 0 ? '\n\n' : '';
    const afterText = '\n';
    
    editorInstance.setCursor(line, 0);
    editorInstance.replaceSelection(beforeText + processedCode + afterText);
    
    // 更新模板使用次数
    updateTemplateUsage(selectedTemplate.id);
    
    // 关闭模态框
    bootstrap.Modal.getInstance(document.getElementById('loadTemplateModal')).hide();
    
    // 重新分析类列表
    setTimeout(analyzeAndUpdateClasses, 500);
    
    showSaveStatus(`成功插入模板类 "${selectedTemplate.name}"`, 'success');
});

// 找到合适的类插入位置
function findClassInsertPosition(code) {
    const lines = code.split('\n');
    let lastClassLine = -1;
    let mainBlockLine = -1;
    
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        
        // 找到最后一个类定义
        if (line.startsWith('class ')) {
            // 找到这个类的结束位置
            let j = i + 1;
            let indentLevel = 0;
            let inClass = true;
            
            while (j < lines.length && inClass) {
                const nextLine = lines[j].trim();
                if (nextLine === '') {
                    j++;
                    continue;
                }
                
                const nextIndent = lines[j].length - lines[j].trimStart().length;
                if (nextIndent === 0 && nextLine !== '') {
                    // 到达了顶级代码，类定义结束
                    lastClassLine = j - 1;
                    inClass = false;
                } else {
                    j++;
                }
            }
            
            if (inClass) {
                // 如果到了文件末尾还在类中
                lastClassLine = lines.length - 1;
            }
        }
        
        // 找到if __name__ == "__main__"块
        if (line.includes('if __name__') && line.includes('__main__')) {
            mainBlockLine = i;
            break;
        }
    }
    
    // 确定插入位置
    let insertLine;
    if (mainBlockLine >= 0) {
        // 在main块之前插入
        insertLine = mainBlockLine;
    } else if (lastClassLine >= 0) {
        // 在最后一个类之后插入
        insertLine = lastClassLine + 1;
    } else {
        // 在文件末尾插入
        insertLine = lines.length;
    }
    
    return { line: insertLine };
}

// 更新模板使用次数
function updateTemplateUsage(templateId) {
    fetch('/modules/api/templates/usage/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ template_id: templateId })
    }).catch(error => {
        console.error('更新模板使用次数失败:', error);
    });
}

// 辅助函数
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// 显示提示信息
function showAlert(message, type = 'info') {
    // 创建提示框
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '9999';
    alertDiv.style.minWidth = '300px';
    
    // 设置图标
    let icon = 'info-circle';
    if (type === 'success') icon = 'check-circle';
    else if (type === 'warning') icon = 'exclamation-triangle';
    else if (type === 'error' || type === 'danger') icon = 'exclamation-circle';
    
    alertDiv.innerHTML = `
        <i class="fas fa-${icon} me-2"></i>${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // 自动移除提示框
    setTimeout(() => {
        if (alertDiv.parentElement) {
            alertDiv.remove();
        }
    }, type === 'error' ? 5000 : 3000); // 错误信息显示更长时间
}

// =============== 模块风格相关功能 ===============

// 全局变量
let currentSelectedClass = null;
let availableStyles = [];
let selectedStyleId = null;

// 显示模块风格选择模态框
function showModuleStylesModal() {
    // 首先检查是否处于编辑状态
    if (!isEditMode) {
        showAlert('只有在编辑模式下才能使用模块风格功能。请先点击"编辑"按钮。', 'warning');
        return;
    }
    
    // 检查是否有选中的类
    const selectedClassElement = document.querySelector('.class-item.selected');
    if (!selectedClassElement) {
        showAlert('请先在类列表中选择一个类', 'warning');
        return;
    }
    
    // 获取选中类的信息 - 使用data属性获取纯净的类名
    let className = selectedClassElement.getAttribute('data-class-name');
    
    // 如果data属性不存在，尝试从HTML中提取纯净的类名
    if (!className) {
        const classNameElement = selectedClassElement.querySelector('.class-name strong');
        if (classNameElement) {
            className = classNameElement.textContent.trim();
        } else {
            // 备用方法：从textContent中提取，去掉额外的文本
            const fullText = selectedClassElement.querySelector('.class-name').textContent;
            // 移除"(已在__all__中)"等额外文本
            className = fullText.replace(/\s*\([^)]*\)\s*/g, '').trim();
        }
    }
    
    console.log('获取到的类名:', className);
    
    currentSelectedClass = {
        name: className,
        element: selectedClassElement
    };
    
    // 更新模态框中的类信息显示
    document.getElementById('selectedClassName').textContent = className;
    
    // 显示模态框
    const modal = new bootstrap.Modal(document.getElementById('moduleStylesModal'));
    modal.show();
    
    // 加载可用的模块风格
    loadModuleStyles();
}

// 加载模块风格列表
function loadModuleStyles() {
    const container = document.getElementById('moduleStylesList');
    container.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> 加载风格列表...</div>';
    
    fetch('/modules/api/editor-styles/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                availableStyles = data.styles;
                renderModuleStylesList();
            } else {
                container.innerHTML = '<div class="alert alert-danger">加载风格失败: ' + data.error + '</div>';
            }
        })
        .catch(error => {
            console.error('加载模块风格错误:', error);
            container.innerHTML = '<div class="alert alert-danger">网络错误，无法加载风格列表</div>';
        });
}

// 渲染模块风格列表
function renderModuleStylesList() {
    const container = document.getElementById('moduleStylesList');
    
    if (!availableStyles || availableStyles.length === 0) {
        container.innerHTML = '<div class="alert alert-info">暂无可用的模块风格</div>';
        return;
    }
    
    let html = '';
    availableStyles.forEach(style => {
        const previewCode = style.code_snippet || style.formatted_code;
        html += `
            <div class="style-item" data-style-id="${style.id}" onclick="selectModuleStyle(${style.id})">
                <div class="style-item-header">
                    <strong>${style.name}</strong>
                    <small class="text-muted">排序: ${style.order}</small>
                </div>
                ${style.description ? `<div class="style-description">${style.description}</div>` : ''}
                <div class="style-preview-mini">
                    <pre><code>${previewCode.substring(0, 100)}${previewCode.length > 100 ? '...' : ''}</code></pre>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// 选择模块风格
function selectModuleStyle(styleId) {
    selectedStyleId = styleId;
    
    // 更新选中状态
    document.querySelectorAll('.style-item').forEach(item => {
        item.classList.remove('selected');
    });
    document.querySelector(`[data-style-id="${styleId}"]`).classList.add('selected');
    
    // 显示预览
    const style = availableStyles.find(s => s.id === styleId);
    if (style) {
        showStylePreview(style);
        document.getElementById('insertStyleBtn').disabled = false;
    }
}

// 显示风格预览
function showStylePreview(style) {
    const container = document.getElementById('stylePreviewContainer');
    container.innerHTML = `
        <div class="style-preview-full">
            <h6>${style.name}</h6>
            ${style.description ? `<p class="text-muted small">${style.description}</p>` : ''}
            <pre class="bg-light p-3 rounded"><code>${style.code_snippet || style.formatted_code}</code></pre>
            <small class="text-info">
                <i class="fas fa-info-circle"></i> 
                此代码将插入到类 "${currentSelectedClass.name}" 中
            </small>
        </div>
    `;
}

// 插入风格到类中
function insertStyleToClass() {
    // 首先检查是否处于编辑状态
    if (!isEditMode) {
        showAlert('只有在编辑模式下才能插入模块风格。请先点击"编辑"按钮。', 'warning');
        return;
    }
    
    // 验证所有必需的变量
    if (!selectedStyleId || !currentSelectedClass) {
        showAlert('请选择一个风格和类', 'warning');
        return;
    }
    
    if (typeof availableStyles === 'undefined' || !availableStyles) {
        showAlert('风格列表未加载，请刷新页面重试', 'error');
        return;
    }
    
    const style = availableStyles.find(s => s.id === selectedStyleId);
    if (!style) {
        showAlert('找不到选中的风格', 'error');
        return;
    }
    
    if (!editorInstance) {
        showAlert('编辑器未初始化', 'error');
        return;
    }
    
    // 验证currentSelectedClass的结构
    if (!currentSelectedClass.name) {
        showAlert('选中的类信息不完整', 'error');
        return;
    }
    
    // 找到类在代码中的位置
    const className = currentSelectedClass.name;
    
    // 清理类名，移除可能的额外字符和空白
    const cleanClassName = className.replace(/\s*\([^)]*\)\s*/g, '').trim();
    
    console.log('原始类名:', className);
    console.log('清理后类名:', cleanClassName);
    
    const content = editorInstance.getValue();
    
    if (!content || content.trim() === '') {
        showAlert('编辑器内容为空', 'error');
        return;
    }
    
    const lines = content.split('\n');
    
    // 查找类定义行
    let classLineIndex = -1;
    // 使用与类分析一致的正则表达式模式，支持装饰器
    const escapedClassName = cleanClassName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); // 转义特殊字符
    const classPattern = new RegExp(`^class\\s+${escapedClassName}\\s*(?:\\([^)]*\\))?:`);
    
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        
        if (classPattern.test(line)) {
            classLineIndex = i;
            console.log(`在第 ${i+1} 行找到类 ${cleanClassName}: ${line}`);
            break;
        }
    }
    
    if (classLineIndex === -1) {
        showAlert(`无法在代码中找到类 "${cleanClassName}" 的定义。请检查：
1. 类名是否正确拼写
2. 类定义是否符合Python语法格式
3. 是否存在语法错误
4. 编辑器内容是否已正确加载`, 'error');
        return;
    }
    
    // 检测类中现有成员的缩进级别
    let classIndent = '';
    let insertPosition = classLineIndex + 1;
    
    // 跳过空行和docstring，同时检测缩进
    while (insertPosition < lines.length) {
        const line = lines[insertPosition];
        const trimmed = line.trim();
        
        // 跳过空行
        if (trimmed === '') {
            insertPosition++;
            continue;
        }
        
        // 跳过docstring的开始和结束
        if (trimmed.startsWith('"""') || trimmed.startsWith("'''")) {
            insertPosition++;
            continue;
        }
        
        // 如果找到类的第一个成员（def 或其他），检测其缩进
        if (trimmed.startsWith('def ') || trimmed.startsWith('def\t') || 
            (line.length > 0 && line[0] === ' ' && trimmed.length > 0)) {
            // 计算这一行的缩进
            const match = line.match(/^(\s*)/);
            if (match) {
                classIndent = match[1];
                console.log('检测到类成员缩进:', JSON.stringify(classIndent), '长度:', classIndent.length);
                break;
            }
        }
        
        // 如果遇到下一个类定义或其他顶级定义，停止搜索
        if (trimmed.startsWith('class ') || trimmed.startsWith('def ') && line[0] !== ' ') {
            break;
        }
        
        insertPosition++;
    }
    
    // 如果没有检测到缩进，使用默认的4个空格
    if (classIndent === '') {
        classIndent = '    '; // 4个空格作为默认缩进
        console.log('使用默认缩进: 4个空格');
    }
    
    // 插入风格代码 - 使用原始代码而不是预格式化的代码
    const styleCode = style.code_snippet || style.formatted_code; // 优先使用原始代码
    const styleLines = styleCode.split('\n');
    
    // 使用检测到的缩进级别格式化代码
    const indentedStyleLines = styleLines.map(line => {
        if (line.trim() === '') return line;
        return classIndent + line; // 使用检测到的缩进
    });
    
    // 在指定位置插入代码
    lines.splice(insertPosition, 0, ...indentedStyleLines);
    
    // 更新编辑器内容
    const newContent = lines.join('\n');
    editorInstance.setValue(newContent);
    
    // 记录使用风格
    recordStyleUsage(selectedStyleId);
    
    // 关闭模态框
    const modal = bootstrap.Modal.getInstance(document.getElementById('moduleStylesModal'));
    modal.hide();
    
    // 显示成功消息
    showAlert(`成功将风格 "${style.name}" 插入到类 "${className}" 中！`, 'success');
}

// 获取CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// 记录风格使用情况
function recordStyleUsage(styleId) {
    fetch('/modules/api/use-style/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            style_id: styleId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            console.warn('记录风格使用失败:', data.error);
        }
    })
    .catch(error => {
        console.warn('记录风格使用错误:', error);
    });
}

// 绑定插入按钮事件
document.addEventListener('DOMContentLoaded', function() {
    const insertBtn = document.getElementById('insertStyleBtn');
    if (insertBtn) {
        insertBtn.addEventListener('click', insertStyleToClass);
    }
});

// 修改类列表点击事件，支持选择状态
function enhanceClassListSelection() {
    document.addEventListener('click', function(e) {
        if (e.target.closest('.class-item')) {
            // 移除之前的选中状态
            document.querySelectorAll('.class-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // 添加选中状态到当前项
            const classItem = e.target.closest('.class-item');
            classItem.classList.add('selected');
        }
    });
}

// 初始化类选择增强功能
enhanceClassListSelection();

</script>

<!-- 模块风格选择模态框 -->
<div class="modal fade" id="moduleStylesModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-palette me-2"></i>选择模块风格
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    选择下方的代码风格插入到当前光标位置，代码会自动格式化并应用正确的缩进。
                </div>
                <div id="moduleStylesList" class="row">
                    <div class="col-12 text-center">
                        <i class="fas fa-spinner fa-spin"></i> 加载中...
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-outline-primary" onclick="loadModuleStyles()">
                    <i class="fas fa-sync me-2"></i>刷新列表
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 隐藏的CSRF token -->
<!-- {% csrf_token %}
{% endblock %} -->
