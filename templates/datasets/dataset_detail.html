{% extends 'base.html' %}

{% block title %}{{ dataset.name }} - 数据集详情{% endblock %}

{% block content %}
<!-- 页面头部 -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'datasets:list' %}">数据集</a></li>
                <li class="breadcrumb-item active">{{ dataset.name }}</li>
            </ol>
        </nav>
        <h1 class="display-6">
            <i class="fas fa-database me-3 text-primary"></i>{{ dataset.name }}
            {% if dataset.is_valid %}
                <span class="badge bg-success ms-3">有效</span>
            {% else %}
                <span class="badge bg-warning ms-3">无效</span>
            {% endif %}
        </h1>
        {% if dataset.description %}
        <p class="lead text-muted">{{ dataset.description }}</p>
        {% endif %}
    </div>
    <div class="btn-group">
        <button class="btn btn-outline-primary" onclick="copyDatasetPath()">
            <i class="fas fa-copy me-1"></i>复制路径
        </button>
        <a href="{% url 'datasets:api' dataset.name %}" class="btn btn-outline-info" target="_blank">
            <i class="fas fa-code me-1"></i>API
        </a>
        <a href="{% url 'datasets:list' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>返回列表
        </a>
    </div>
</div>

<!-- 快速统计卡片 -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <i class="fas fa-file-alt fa-2x mb-2"></i>
                <h5>文件大小</h5>
                <h4>{{ dataset.size|filesizeformat }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <i class="fas fa-tags fa-2x mb-2"></i>
                <h5>类别数量</h5>
                <h4>{% if dataset.names %}{{ dataset.names|length }}{% else %}未知{% endif %}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <i class="fas fa-clock fa-2x mb-2"></i>
                <h5>修改时间</h5>
                <h6>{% if dataset.modified_time %}{{ dataset.modified_time|date:"m月d日" }}{% else %}未知{% endif %}</h6>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <i class="fas fa-check-circle fa-2x mb-2"></i>
                <h5>配置状态</h5>
                <h6>{% if dataset.is_valid %}配置正确{% else %}配置错误{% endif %}</h6>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- 左侧信息面板 -->
    <div class="col-lg-4">
        <!-- 基本信息 -->
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2 text-primary"></i>基本信息</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless table-sm">
                    <tr>
                        <th width="90">文件名:</th>
                        <td><code class="text-dark">{{ dataset.display_filename }}</code></td>
                    </tr>
                    <tr>
                        <th>完整路径:</th>
                        <td>
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" value="{{ dataset.display_file_path }}" readonly>
                                <button class="btn btn-outline-secondary btn-sm" onclick="copyToClipboard('{{ dataset.display_file_path }}')">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th>文件大小:</th>
                        <td><span class="badge bg-light text-dark">{{ dataset.size|filesizeformat }}</span></td>
                    </tr>
                    {% if dataset.modified_time %}
                    <tr>
                        <th>修改时间:</th>
                        <td>{{ dataset.modified_time|date:"Y年m月d日 H:i:s" }}</td>
                    </tr>
                    {% endif %}
                    {% if dataset.is_reference_type %}
                    <tr>
                        <th>类型:</th>
                        <td>
                            <span class="badge bg-info">引用类型</span>
                            {% if dataset.referenced_file_exists %}
                                <span class="badge bg-success ms-1">文件存在</span>
                            {% else %}
                                <span class="badge bg-danger ms-1">文件不存在</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endif %}
                </table>
            </div>
        </div>

        {% if dataset.is_valid and dataset.names %}
        <!-- 类别信息 -->
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-tags me-2 text-success"></i>类别列表</h5>
                <span class="badge bg-success">{{ dataset.names|length }} 个类别</span>
            </div>
            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                {% if dataset.names|length <= 15 %}
                    <!-- 少量类别显示为标签 -->
                    <div class="row g-2">
                        {% for name in dataset.names %}
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center p-2 border rounded">
                                <span class="fw-bold text-muted me-2">{{ forloop.counter0 }}:</span>
                                <span class="flex-grow-1">{{ name }}</span>
                                <small class="text-muted">ID{{ forloop.counter0 }}</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <!-- 大量类别显示为紧凑列表 -->
                    <div class="row">
                        {% for name in dataset.names %}
                        <div class="col-md-6 mb-1">
                            <small class="text-muted">{{ forloop.counter0 }}:</small> 
                            <span class="text-truncate d-inline-block" style="max-width: 120px;" title="{{ name }}">{{ name }}</span>
                        </div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        {% if dataset.is_reference_type %}
        <!-- 引用文件信息 -->
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-link me-2 text-info"></i>引用文件信息</h5>
            </div>
            <div class="card-body">
                {% if dataset.original_data.name %}
                <p><strong>引用文件:</strong> <code class="text-dark">{{ dataset.original_data.name }}</code></p>
                {% endif %}
                
                {% if dataset.original_data.file %}
                <div class="mb-3">
                    <strong>完整路径:</strong>
                    <div class="input-group input-group-sm mt-1">
                        <input type="text" class="form-control" value="{{ dataset.original_data.file }}" readonly>
                        <button class="btn btn-outline-secondary" onclick="copyToClipboard('{{ dataset.original_data.file }}')">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                    <div class="mt-1">
                        {% if dataset.referenced_file_exists %}
                            <small class="text-success"><i class="fas fa-check-circle me-1"></i>引用文件存在</small>
                        {% else %}
                            <small class="text-danger"><i class="fas fa-times-circle me-1"></i>引用文件不存在</small>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                {% if dataset.reference_error %}
                <div class="alert alert-warning alert-sm">
                    <i class="fas fa-exclamation-triangle me-2"></i>{{ dataset.reference_error }}
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        {% if dataset.is_valid %}
        <!-- 数据路径配置 -->
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-folder-open me-2 text-warning"></i>数据路径配置</h5>
            </div>
            <div class="card-body">
                {% if dataset.path %}
                <div class="mb-3">
                    <label class="form-label fw-bold">数据根路径:</label>
                    {% if dataset.path_original != dataset.path %}
                    <div class="mb-1">
                        <small class="text-muted">原始路径:</small>
                        <code class="text-secondary">{{ dataset.path_original }}</code>
                    </div>
                    {% endif %}
                    <div class="input-group input-group-sm">
                        <input type="text" class="form-control" value="{{ dataset.path }}" readonly>
                        <button class="btn btn-outline-secondary" onclick="copyToClipboard('{{ dataset.path }}')">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                    {% if dataset.path_original != dataset.path %}
                    <div class="mt-1">
                        <small class="text-success"><i class="fas fa-check-circle me-1"></i>已解析为绝对路径</small>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
                
                {% if dataset.train %}
                <div class="mb-3">
                    <label class="form-label fw-bold text-primary">训练集路径:</label>
                    {% if dataset.train_original != dataset.train %}
                    <div class="mb-1">
                        <small class="text-muted">原始路径:</small>
                        <code class="text-secondary">{{ dataset.train_original }}</code>
                    </div>
                    {% endif %}
                    <div class="input-group input-group-sm">
                        <input type="text" class="form-control" value="{{ dataset.train }}" readonly>
                        <button class="btn btn-outline-secondary" onclick="copyToClipboard('{{ dataset.train }}')">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                    {% if dataset.train_original != dataset.train %}
                    <div class="mt-1">
                        <small class="text-success"><i class="fas fa-check-circle me-1"></i>已解析为绝对路径</small>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
                
                {% if dataset.val %}
                <div class="mb-3">
                    <label class="form-label fw-bold text-success">验证集路径:</label>
                    {% if dataset.val_original != dataset.val %}
                    <div class="mb-1">
                        <small class="text-muted">原始路径:</small>
                        <code class="text-secondary">{{ dataset.val_original }}</code>
                    </div>
                    {% endif %}
                    <div class="input-group input-group-sm">
                        <input type="text" class="form-control" value="{{ dataset.val }}" readonly>
                        <button class="btn btn-outline-secondary" onclick="copyToClipboard('{{ dataset.val }}')">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                    {% if dataset.val_original != dataset.val %}
                    <div class="mt-1">
                        <small class="text-success"><i class="fas fa-check-circle me-1"></i>已解析为绝对路径</small>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
                
                {% if dataset.test %}
                <div class="mb-3">
                    <label class="form-label fw-bold text-info">测试集路径:</label>
                    {% if dataset.test_original != dataset.test %}
                    <div class="mb-1">
                        <small class="text-muted">原始路径:</small>
                        <code class="text-secondary">{{ dataset.test_original }}</code>
                    </div>
                    {% endif %}
                    <div class="input-group input-group-sm">
                        <input type="text" class="form-control" value="{{ dataset.test }}" readonly>
                        <button class="btn btn-outline-secondary" onclick="copyToClipboard('{{ dataset.test }}')">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                    {% if dataset.test_original != dataset.test %}
                    <div class="mt-1">
                        <small class="text-success"><i class="fas fa-check-circle me-1"></i>已解析为绝对路径</small>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
                
                {% if dataset.download %}
                <div class="alert alert-info alert-sm">
                    <strong><i class="fas fa-download me-1"></i>下载说明:</strong><br>
                    {{ dataset.download }}
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- 右侧内容区域 -->
    <div class="col-lg-8">
        <!-- YAML配置内容 -->
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-file-code me-2 text-secondary"></i>YAML 配置文件</h5>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-secondary" onclick="copyYamlContent()">
                        <i class="fas fa-copy me-1"></i>复制内容
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="downloadYaml()">
                        <i class="fas fa-download me-1"></i>下载文件
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="bg-light border-bottom p-3">
                    <div class="row">
                        <div class="col-md-6">
                            <small class="text-muted">
                                <i class="fas fa-file me-1"></i><strong>文件:</strong> {{ dataset.display_filename }}
                            </small>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <small class="text-muted">
                                <i class="fas fa-weight me-1"></i><strong>大小:</strong> {{ dataset.size|filesizeformat }}
                            </small>
                        </div>
                    </div>
                </div>
                <div class="position-relative">
                    <pre class="mb-0 p-3" style="max-height: 500px; overflow-y: auto; background: #f8f9fa;"><code id="yaml-content" class="language-yaml">{{ yaml_content }}</code></pre>
                    <div class="position-absolute top-0 end-0 m-2">
                        <button class="btn btn-sm btn-light opacity-75" onclick="copyYamlContent()">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        {% if dataset.is_valid %}
        <!-- 快速操作面板 -->
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-rocket me-2"></i>快速操作</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary"><i class="fas fa-play me-1"></i>开始实验</h6>
                        <p class="text-muted small">使用此数据集创建新的训练实验</p>
                        <div class="d-grid">
                            <a href="{% url 'experiments:create' %}?dataset={{ dataset.name }}" class="btn btn-success">
                                <i class="fas fa-plus me-1"></i>创建实验
                            </a>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-info"><i class="fas fa-terminal me-1"></i>命令行使用</h6>
                        <p class="text-muted small">在终端中使用此数据集的示例命令</p>
                        <div class="bg-dark text-light p-3 rounded mb-2">
                            <code id="command-example" class="text-light">yolo detect train data={{ dataset.display_file_path }} model=yolov8n.pt epochs=100 imgsz=640</code>
                        </div>
                        <button class="btn btn-sm btn-outline-primary w-100" onclick="copyToClipboard(document.getElementById('command-example').textContent.trim())">
                            <i class="fas fa-copy me-1"></i>复制命令
                        </button>
                    </div>
                </div>
                
                <hr class="my-4">
                
                <div class="row text-center">
                    <div class="col">
                        <a href="{% url 'datasets:api' dataset.name %}" target="_blank" class="btn btn-outline-info">
                            <i class="fas fa-code me-1"></i>查看API
                        </a>
                    </div>
                    <div class="col">
                        <button class="btn btn-outline-warning" onclick="validateDataset()">
                            <i class="fas fa-check-double me-1"></i>验证配置
                        </button>
                    </div>
                    <div class="col">
                        <a href="{% url 'datasets:stats' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-chart-bar me-1"></i>数据集统计
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Toast 提示框 -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050">
    <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="fas fa-info-circle text-primary me-2"></i>
            <strong class="me-auto">操作提示</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toast-body">
            <!-- Toast 内容 -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% load static %}
<script src="{% static 'js/dataset_detail.js' %}"></script>
{% endblock %}
